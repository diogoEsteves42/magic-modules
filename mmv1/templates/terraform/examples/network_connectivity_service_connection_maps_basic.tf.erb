resource "google_compute_network" "consumer_net" {
  name                    = "<%= ctx[:vars]['consumer_network_name'] %>"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "consumer_subnet" {
  name          = "<%= ctx[:vars]['consumer_subnetwork_name'] %>"
  purpose       = "PRIVATE"
  ip_cidr_range = "10.0.0.0/16"
  region        = "us-central1"
  network       = google_compute_network.consumer_net.id
}

resource "google_compute_network" "producer_net" {
  name                    = "<%= ctx[:vars]['producer_network_name'] %>"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "producer_subnet_psc" {
  name          = "<%= ctx[:vars]['producer_subnetwork_name'] %>"
  region        = "us-central1"
  purpose       = "PRIVATE_SERVICE_CONNECT"
  network       = google_compute_network.producer_net.id
  ip_cidr_range = "10.1.0.0/16"
}

resource "google_compute_subnetwork" "producer_subnet" {
  name          = "<%= ctx[:vars]['producer_subnetwork_name'] %>"
  region        = "us-central1"
  network       = google_compute_network.producer_net.id
  ip_cidr_range = "10.0.0.0/16"
}

resource "google_compute_service_attachment" "default" {
  provider = google-beta
  name     = "<%= ctx[:vars]['service_attachment'] %>"
  region   = local.region
  project  = local.projectId

  enable_proxy_protocol = true
  connection_preference = "ACCEPT_MANUAL"
  nat_subnets           = [google_compute_subnetwork.producer_subnet_psc.id]
  target_service        = google_compute_forwarding_rule.default.id
}

resource "google_compute_forwarding_rule" "default" {
  name    = "<%= ctx[:vars]['forwarding_rule_name'] %>"
  project = local.projectId
  region  = local.region

  load_balancing_scheme = "INTERNAL"
  backend_service       = google_compute_region_backend_service.producer_service_backend.id
  all_ports             = true
  network               = google_compute_network.producer_net.name
  subnetwork            = google_compute_subnetwork.subnetwork_producer.name
}

resource "google_compute_region_backend_service" "producer_service_backend" {
  name    = "<%= ctx[:vars]['backend_service_name'] %>"
  project = local.projectId
  region  = local.region
}

resource "google_network_connectivity_service_connection_policy" "default" {
  name = "<%= ctx[:vars]['connection_policy_name'] %>"
  location = "us-central1"

  service_class = "gcp-memorystore-redis"
  network       = google_compute_network.consumer_net.id
  psc_config {
    subnetworks = [google_compute_subnetwork.subnetwork_consumer.id]
    limit = 2
  }
}

resource "google_network_connectivity_service_connection_map" "default" {
    name = "<%= ctx[:vars]['resource_name'] %>"
    service_class = "gcp-memorystore-redis"
    producer_psc_configs {
        service_attachment_uri = google_compute_service_attachment.default.id
    }
    consumer_psc_configs {
        project = google_compute_network.subnetwork_consumer.project
        network = google_compute_network.subnetwork_consumer.id
    }
}
